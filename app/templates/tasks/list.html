{% extends "layout/base.html" %}
{% block title %}Задачи{% endblock %}

{% block extra_head %}
<script src="{{ url_for('static', filename='js/tasks.js') }}" defer></script>
{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-4">
    
    {% if can_create_task %}
        <button type="button"
                class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-blue-600 text-white hover:bg-blue-700"
                onclick="openTaskModal()">
            + Новая задача
        </button>
    {% endif %}
</div>

<div class="bg-white rounded-2xl shadow p-4 mb-4">
    <form method="get" class="flex flex-wrap items-end gap-4 text-sm">
        <div>
            <label class="block text-xs text-slate-500 mb-1">Статус</label>
            <select name="status" class="border rounded-lg px-3 py-1.5 text-sm">
                <option value="all">— все —</option>
                {% for s in TASK_STATUSES %}
                    <option value="{{ s }}" {% if status_filter == s %}selected{% endif %}>
                        {{ s }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="block text-xs text-slate-500 mb-1">Приоритет</label>
            <select name="priority" class="border rounded-lg px-3 py-1.5 text-sm">
                <option value="all">— все —</option>
                {% for p in PRIORITIES %}
                    <option value="{{ p }}" {% if priority_filter == p %}selected{% endif %}>
                        {{ p }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="ml-auto flex gap-2">
            <button class="px-3 py-1.5 rounded-full text-sm bg-slate-100 hover:bg-slate-200" type="submit">
                Применить
            </button>
            <a href="{{ url_for('tasks_views.list_tasks') }}" class="px-3 py-1.5 rounded-full text-sm bg-slate-50 hover:bg-slate-100">
                Сбросить
            </a>
            <a href="{{ url_for('tasks_exports.export_tasks_xlsx') }}" class="px-3 py-1.5 rounded-full text-sm bg-emerald-600 text-white hover:bg-emerald-700">
                Отчёт Excel
            </a>
        </div>
    </form>
</div>

<div class="bg-white rounded-2xl shadow overflow-hidden">
    <table class="min-w-full text-sm">
        <thead class="bg-slate-50 text-slate-600">
        <tr>
            <th class="px-3 py-2 text-left">ID</th>
            <th class="px-3 py-2 text-left">Название</th>
            <th class="px-3 py-2 text-left">Статус</th>
            <th class="px-3 py-2 text-left">Приоритет</th>
            <th class="px-3 py-2 text-left">Исполнитель</th>
            <th class="px-3 py-2 text-left">Постановщик</th>
            <th class="px-3 py-2 text-left">Создана</th>
            <th class="px-3 py-2 text-left">Срок</th>
            <th class="px-3 py-2 text-right">Действия</th>
        </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
        {% for t in tasks %}
            <tr class="hover:bg-slate-50">
                <td class="px-3 py-2 align-top text-slate-500">{{ t.id }}</td>
                <td class="px-3 py-2 align-top">
                    <div class="font-medium">{{ t.title }}</div>
                    {% if t.description %}
                        <div class="text-xs text-slate-500 line-clamp-2">{{ t.description }}</div>
                    {% endif %}
                </td>
                <td class="px-3 py-2 align-top">
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs
                        {% if t.status == 'Новая' %} bg-blue-100 text-blue-700
                        {% elif t.status == 'В работе' %} bg-amber-100 text-amber-700
                        {% elif t.status == 'Выполнена' %} bg-emerald-100 text-emerald-700
                        {% elif t.status == 'Отложена' %} bg-slate-100 text-slate-700
                        {% elif t.status == 'Закрыта' %} bg-slate-300 text-slate-900
                        {% else %} bg-slate-100 text-slate-700
                        {% endif %}">
                        {{ t.status }}
                    </span>
                </td>
                <td class="px-3 py-2 align-top">
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs
                        {% if t.priority == 'Высокий' %} bg-red-100 text-red-700
                        {% elif t.priority == 'Средний' %} bg-amber-100 text-amber-700
                        {% else %} bg-slate-100 text-slate-700
                        {% endif %}">
                        {{ t.priority }}
                    </span>
                </td>
                <td class="px-3 py-2 align-top text-xs">
                    {{ t.assigned_to.full_name or t.assigned_to.username }}
                </td>
                <td class="px-3 py-2 align-top text-xs">
                    {{ t.assigned_by.full_name or t.assigned_by.username }}
                </td>
                <td class="px-3 py-2 align-top text-xs text-slate-500">
                    {{ t.created_at.strftime('%Y-%m-%d %H:%M') }}
                </td>
                <td class="px-3 py-2 align-top text-xs">
                    {% if t.due_date %}
                        {% if t.due_date < current_date %}
                            <span class="text-red-600 font-semibold">
                                {{ t.due_date.strftime('%Y-%m-%d') }}
                            </span>
                        {% else %}
                            <span class="text-slate-700">
                                {{ t.due_date.strftime('%Y-%m-%d') }}
                            </span>
                        {% endif %}
                    {% else %}
                        <span class="text-slate-400">—</span>
                    {% endif %}
                </td>
                <td class="px-3 py-2 align-top text-right">
                    <button type="button"
                            class="text-blue-600 hover:text-blue-800 text-xs"
                            onclick="openTaskModal({{ t.id }})">
                        Открыть
                    </button>
                </td>
            </tr>
        {% else %}
            <tr>
                <td colspan="8" class="px-3 py-6 text-center text-slate-500 text-sm">
                    Задач пока нет. Создайте первую.
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

{% include "tasks/task_modal.html" %}
{% endblock %}
